---
import Social from "@/components/icons/socials/Social";
import Slide from "@/components/Slide.astro";
import FooterEmailCTA from "@/components/CTA/FooterEmailCTA.astro";
import FooterBlock from "./FooterBlock.astro";
import { ThemeToggle } from "../../components/theme/ThemeToggle";
import {
  getRoutesByLanguage,
  productRoutes,
  partnerRoutes,
  contactRoutes,
  guidePageRoutes,
  guideRoutes,
} from "../../content/routes.tsx";
import type { Lang } from "../../config/languages.ts";

export interface Props {
  lang?: Lang;
}

const { lang = "en" } = Astro.props as Props;

const localizedRoutes = getRoutesByLanguage(lang);

// Filter routes by category - use guide page routes
const guidePageLinks = localizedRoutes.filter((route) => {
  const baseRoute = guidePageRoutes.find(
    (gr) =>
      gr.slugTranslations?.[lang] === route.slug || gr.slug === route.slug,
  );
  return !!baseRoute;
});

const productLinks = localizedRoutes.filter((route) => {
  // Find the base route that matches this translated route
  const baseRoute = productRoutes.find(
    (pr) =>
      pr.slugTranslations?.[lang] === route.slug || pr.slug === route.slug,
  );
  return !!baseRoute;
});

const partnerLinks = localizedRoutes.filter((route) => {
  // Find the base route that matches this translated route
  const baseRoute = partnerRoutes.find(
    (pr) =>
      pr.slugTranslations?.[lang] === route.slug || pr.slug === route.slug,
  );
  return !!baseRoute;
});

const contactLinks = localizedRoutes.filter((route) => {
  // Find the base route that matches this translated route
  const baseRoute = contactRoutes.find(
    (cr) =>
      cr.slugTranslations?.[lang] === route.slug || cr.slug === route.slug,
  );
  return !!baseRoute;
});

const faqLinks = localizedRoutes.filter((route) =>
  route.slug.startsWith("FAQs/"),
);

// Get section titles from routes.tsx content
const getSectionTitle = (routes: any[], sectionSlug: string) => {
  const route = routes.find((r) => r.slug === sectionSlug);
  return route?.title?.[lang] || route?.title?.en || sectionSlug;
};

const guideSectionTitles: Record<Lang, string> = {
  en: "Recovery Guide",
  de: "Genesungsleitfaden",
  fr: "Guide de Récupération",
  es: "Guía de Recuperación",
  it: "Guida al Recupero",
};

// External guide links (to guide.thetismedical.com)
const externalGuideLinks = [
  {
    href: guideRoutes.essentials.href,
    title:
      guideRoutes.essentials.title[lang] || guideRoutes.essentials.title.en,
    description:
      guideRoutes.essentials.description[lang] ||
      guideRoutes.essentials.description.en,
  },
  {
    href: guideRoutes.professionals.href,
    title:
      guideRoutes.professionals.title[lang] ||
      guideRoutes.professionals.title.en,
    description:
      guideRoutes.professionals.description[lang] ||
      guideRoutes.professionals.description.en,
  },
];

const externalGuideSectionTitles: Record<Lang, string> = {
  en: "Full Courses",
  de: "Vollständige Kurse",
  fr: "Cours Complets",
  es: "Cursos Completos",
  it: "Corsi Completi",
};

const footerLinks = {
  guide: {
    title: guideSectionTitles[lang],
    links: guidePageLinks,
  },
  externalGuides: {
    title: externalGuideSectionTitles[lang],
    links: externalGuideLinks,
  },
  company: {
    title: getSectionTitle(contactRoutes, "contact"),
    links: contactLinks,
  },
  products: {
    title: getSectionTitle(productRoutes, "achilles-rupture-splint"),
    links: productLinks,
  },
  patientGuides: {
    title: "Patient Guides", // This is a generic title, not from a specific route
    links: faqLinks,
  },
  professionals: {
    title: getSectionTitle(partnerRoutes, "professionals"),
    links: partnerLinks,
  },
};

// Get "Stay in Touch" title based on language
const stayInTouchTitles = {
  en: "Stay in Touch",
  de: "In Kontakt bleiben",
  fr: "Restez en Contact",
  es: "Manténgase en Contacto",
  it: "Rimani in Contatto",
};

const socials: Array<{
  mode: "mail" | "linkedin" | "instagram" | "facebook";
  color: string;
}> = [
  { mode: "mail", color: "white" },
  { mode: "linkedin", color: "white" },
  { mode: "instagram", color: "white" },
  { mode: "facebook", color: "white" },
];
---

<Slide background="black" className="print:hidden mt-24">
  <footer class="w-full text-white">
    <div
      class="gap-8 lg:gap-12 grid grid-cols-1 lg:grid-cols-3 lg:text-left text-center"
    >
      <!-- Company & Products -->
      <div class="space-y-8">
        <FooterBlock
          title={footerLinks.company.title}
          links={footerLinks.company.links}
        />
        <FooterBlock
          title={footerLinks.products.title}
          links={footerLinks.products.links}
        />
        <!-- Recovery Guide (internal links) -->
        <FooterBlock
          title={footerLinks.guide.title}
          links={footerLinks.guide.links}
        />
        <!-- Full Courses (external links) -->
        <div class="space-y-3">
          <h3 class="font-semibold text-lg">
            {footerLinks.externalGuides.title}
          </h3>
          <ul class="space-y-2">
            {
              footerLinks.externalGuides.links.map((link) => (
                <li>
                  <a
                    href={link.href}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-gray-300 hover:text-white text-sm transition-colors"
                  >
                    {link.title} ↗
                  </a>
                </li>
              ))
            }
          </ul>
        </div>
      </div>

      <!-- Patient Guides -->
      <div>
        <FooterBlock
          title={footerLinks.patientGuides.title}
          links={footerLinks.patientGuides.links}
        />
      </div>

      <!-- Partners & Contact -->
      <div class="space-y-8">
        <FooterBlock
          title={footerLinks.professionals.title}
          links={footerLinks.professionals.links}
        />

        <div class="space-y-4">
          <h3 class="font-semibold text-lg">{stayInTouchTitles[lang]}</h3>
          <FooterEmailCTA />

          <div class="flex flex-col items-center lg:items-start gap-y-4">
            <div class="flex justify-center lg:justify-start gap-4">
              {
                socials.map((social) => (
                  <Social color="white" mode={social.mode} />
                ))
              }
            </div>
            <a
              href="mailto:info@thetismedical.com"
              class="font-semibold text-white hover:text-gray-300 text-base transition-colors"
            >
              info@thetismedical.com
            </a>
          </div>
        </div>
      </div>
    </div>

    <div
      class="flex md:flex-row flex-col justify-center md:justify-between items-center mt-8 pt-6 border-gray-800 border-t"
    >
      <p class="text-gray-300 text-base">&copy; Thetis Medical Ltd 2020-2025</p>
    </div>

    <div class="sr-only">
      <ThemeToggle />
    </div>
  </footer>
</Slide>
