---
import Layout from "../../../layouts/Layout.astro";
import type { SplintData } from "../../../types/splint";
import { getSplintData } from "../../../lib/google-sheets";
import getCheckoutLink from "../../../lib/shopify/checkout-links";
import { buttonVariants } from "../../../components/ui/button";
import Slide from "../../../components/Slide.astro";
import HighlightedWord from "../../../components/HighlightedWord";
import ColorGradient from "../../../components/ColorGradient.astro";
import FreeAndSecure from "../../../components/buy-button/FreeAndSecure";
import LocationSelect from "../../../components/location/LocationSelect";
import DetailsTable from "../../../components/DetailsTable";
import CheckWithCareTeam from "../../../components/buy-button/CheckWithCareTeam";
import {
    buyButtonContent,
    getPurchaseUrl,
    directShipCountries,
} from "../../../content/buy-button-content";

export const prerender = false;

// Function to detect user's country based on IP
async function detectUserCountry(): Promise<string> {
    try {
        // Get the user's IP from the request headers
        const forwardedFor = Astro.request.headers.get("x-forwarded-for");
        const realIp = Astro.request.headers.get("x-real-ip");
        const ip =
            forwardedFor?.split(",")[0] ||
            realIp ||
            Astro.request.headers.get("cf-connecting-ip");

        if (!ip) {
            return "US";
        }

        // Use ipapi.co to get country information
        const response = await fetch(`https://ipapi.co/${ip}/json/`);
        const data = await response.json();

        return data.country_code || "US";
    } catch (error) {
        console.error("Error detecting user country:", error);
        return "US"; // Default to US
    }
}

// Legacy function for region (us/uk) for existing code
function countryToRegion(country: string): "us" | "uk" {
    return country === "GB" ? "uk" : "us";
}

export async function getStaticPaths() {
    // Generate paths for all size/side combinations
    const sizes = ["large", "small"];
    const sides = ["left", "right"];

    return sizes.flatMap((size) =>
        sides.map((side) => ({
            params: { size, side },
        })),
    );
}

const { size, side } = Astro.params;

// Detect user's country
const detectedCountry = await detectUserCountry();
const region = countryToRegion(detectedCountry);

// Set query parameter based on detected region (defaults to US)
const url = new URL(Astro.request.url);
const currentRegion = url.searchParams.get("region") as "us" | "uk" | null;
const finalRegion = currentRegion || region;

// Check if user is in a country we ship to directly
const isDirectShipCountry = directShipCountries.includes(detectedCountry);

// Get purchase info for non-direct-ship countries
const purchaseInfo = getPurchaseUrl(
    detectedCountry,
    size as "large" | "small",
    side as "left" | "right",
);

// Get translations
const t = buyButtonContent.en;

// Get splint data for the detected region
const splintData = await getSplintData(finalRegion);
console.log(
    `Retrieved ${splintData.length} splint records for region: ${finalRegion}`,
);
console.log(`First splint price: ${splintData[0]?.price}`);

const splint = splintData?.find(
    (d) =>
        d.size.toLowerCase() === size && d.title.toLowerCase().includes(side),
);

console.log(`Found splint: ${splint?.title}`);
console.log(`Splint price: ${splint?.price}`);

if (!splint) {
    return Astro.redirect("/404");
}

const checkoutLink = await getCheckoutLink(
    size as "large" | "small",
    side as string,
);

// Generate variant URLs
const variants = [
    { size: "large", side: "left", label: "Large Left" },
    { size: "large", side: "right", label: "Large Right" },
    { size: "small", side: "left", label: "Small Left" },
    { size: "small", side: "right", label: "Small Right" },
];
---

<Layout title={splint.title} description={splint.description} lang="en">
    <main class="">
        <ColorGradient>
            <div class="mx-auto px-4 container">
                <div
                    class="items-center gap-12 grid grid-cols-1 lg:grid-cols-2"
                >
                    <!-- Product Image -->
                    <div class="space-y-6">
                        <img
                            src={splint["image link"]}
                            alt={splint.title}
                            class="shadow-2xl rounded-2xl w-full"
                        />
                    </div>

                    <!-- Product Info -->
                    <div class="space-y-8">
                        <a
                            href={`/splint?region=${finalRegion}`}
                            class="text-primary hover:text-primary/80 text-sm underline"
                        >
                            ← View all splint information and details
                        </a>
                        <!-- Region Selection -->
                        <div class="flex flex-col gap-y-1">
                            <label class="text-gray-600 text-sm">
                                Select your region
                            </label>
                            <LocationSelect
                                client:load
                                finalRegion={finalRegion}
                            />
                        </div>
                        <div>
                            <h1 class="mb-4 font-bold text-4xl leading-tight">
                                Achilles Tendon <HighlightedWord
                                    >Rupture</HighlightedWord
                                > Splint
                            </h1>
                            <p class="mb-6 text-gray-600 text-xl">
                                {
                                    (size as string).charAt(0).toUpperCase() +
                                        (size as string).slice(1)
                                } Size • {
                                    (side as string).charAt(0).toUpperCase() +
                                        (side as string).slice(1)
                                }
                                Side
                            </p>
                        </div>

                        <!-- Size & Side Selection -->
                        <div class="space-y-4">
                            <h3 class="font-semibold text-lg">
                                Select Your Size & Side
                            </h3>
                            <div class="flex flex-wrap gap-3">
                                {
                                    variants.map((variant) => {
                                        const isActive =
                                            variant.size === size &&
                                            variant.side === side;
                                        const href = `/splint/${variant.size}/${variant.side}?region=${finalRegion}`;

                                        return (
                                            <a
                                                href={href}
                                                class:list={[
                                                    "px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 border-2",
                                                    {
                                                        "bg-primary text-white border-primary shadow-lg":
                                                            isActive,
                                                        "bg-white text-gray-700 border-gray-200 hover:border-primary/50 hover:shadow-md":
                                                            !isActive,
                                                    },
                                                ]}
                                            >
                                                {variant.label}
                                            </a>
                                        );
                                    })
                                }
                            </div>
                        </div>

                        <!-- Price and Availability -->
                        <div class="space-y-6">
                            <div class="flex items-baseline gap-4">
                                <span
                                    class="font-semibold text-slate-900 text-2xl"
                                    id="price-display">{splint.price}</span
                                >
                            </div>

                            <div class="flex items-center gap-3">
                                <span
                                    class:list={[
                                        "inline-flex items-center px-3 py-1 rounded-full text-sm font-medium",
                                        {
                                            "bg-primary/20 text-primary border border-primary/30":
                                                splint.availability ===
                                                "in_stock",
                                            "bg-red-100 text-red-800 border border-red-200":
                                                splint.availability !==
                                                "in_stock",
                                        },
                                    ]}
                                >
                                    {
                                        splint.availability === "in_stock"
                                            ? "✓ In Stock"
                                            : "Out of Stock"
                                    }
                                </span>
                                <span class="text-gray-600 text-sm"
                                    >• Ready to ship within 24 hours</span
                                >
                            </div>
                        </div>

                        <CheckWithCareTeam lang="en" client:load />

                        <!-- Add to Cart Button -->
                        <div class="space-y-4">
                            {
                                isDirectShipCountry ? (
                                    // US or UK - show Shopify checkout
                                    checkoutLink ? (
                                        <a
                                            href={checkoutLink}
                                            class={buttonVariants({
                                                size: "xl",
                                                className:
                                                    "w-full text-lg py-4 shadow-lg hover:shadow-xl transition-all duration-200",
                                            })}
                                        >
                                            {t.addToCart} - {splint.price}
                                        </a>
                                    ) : (
                                        <button
                                            class={buttonVariants({
                                                size: "xl",
                                                variant: "outline",
                                                className:
                                                    "w-full text-lg py-4 cursor-not-allowed",
                                            })}
                                            disabled
                                        >
                                            {t.addToCart} - {splint.price}
                                        </button>
                                    )
                                ) : purchaseInfo.type !== "how-to-buy" ? (
                                    // Amazon or Partner country - show external link
                                    <a
                                        href={purchaseInfo.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class={buttonVariants({
                                            size: "xl",
                                            className:
                                                "w-full text-lg py-4 shadow-lg hover:shadow-xl transition-all duration-200 gap-2",
                                        })}
                                    >
                                        {t.buyNow}
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="w-4 h-4"
                                        >
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                            <polyline points="15 3 21 3 21 9" />
                                            <line
                                                x1="10"
                                                y1="14"
                                                x2="21"
                                                y2="3"
                                            />
                                        </svg>
                                    </a>
                                ) : (
                                    // Unknown country - link to how-to-buy
                                    <a
                                        href="/how-to-buy"
                                        class={buttonVariants({
                                            size: "xl",
                                            variant: "outline",
                                            className:
                                                "w-full text-lg py-4 shadow-lg hover:shadow-xl transition-all duration-200",
                                        })}
                                    >
                                        {t.viewOptions}
                                    </a>
                                )
                            }
                            <br />

                            <FreeAndSecure lang="en" />
                        </div>
                    </div>
                </div>
            </div>
        </ColorGradient>

        <!-- Description Section -->
        <section class="bg-white py-16">
            <div class="mx-auto px-4 container">
                <div class="mx-auto max-w-4xl">
                    <h2 class="mb-8 font-semibold text-3xl text-center">
                        What Makes This <HighlightedWord
                            >Splint Special</HighlightedWord
                        >
                    </h2>
                    <div class="max-w-none prose prose-lg">
                        <div
                            class="text-gray-700 leading-relaxed whitespace-pre-wrap"
                        >
                            {splint.description}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Product Details Section -->
        <Slide>
            <DetailsTable splint={splint} />
        </Slide>
    </main>
</Layout>
